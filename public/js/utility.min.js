"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),Utility={};Utility.Collection=function(){var t=function(){function t(e){_classCallCheck(this,t),this._items=e||{},this._count=Object.keys(this._items).length}return _createClass(t,[{key:"has",value:function(t){return void 0!==this._items[t]}},{key:"hasItem",value:function(t){var e=0;for(e in this._items)if(this._items[e]===t)return!0;return!1}},{key:"add",value:function(t){return this.put(this._count,t)}},{key:"put",value:function(t,e){return this._count+=this.has(t)?0:1,this._items[t]=e,!0}},{key:"all",value:function(){var t={};return this.each(function(e,n){t[n]=e}),t}},{key:"get",value:function(t){return this._items[t]}},{key:"first",value:function(){return this.values().get(0)}},{key:"last",value:function(){var t=this.values();return t.get(t.count()-1)}},{key:"findOrGet",value:function(t,e){return this.has(t)||this.put(t,e()),this.get(t)}},{key:"count",value:function(){return this._count}},{key:"isEmpty",value:function(){return 0===this._count}},{key:"remove",value:function(t){this.has(t)&&(delete this._items[t],this._count-=1)}},{key:"each",value:function(t){var e;for(e in this._items)if(t(this._items[e],e)===!1)return 0}},{key:"map",value:function(e){return this.reduce(new t,function(t,n,i){return t.put(i,e(n,i)),t})}},{key:"filter",value:function(e){var n=new t;return this.each(function(t,i){e(t,i)&&n.put(i,t)}),n}},{key:"reduce",value:function(t,e){return this.each(function(n,i){t=e(t,n,i)}),t}},{key:"keys",value:function(){var e=new t;return this.each(function(t,n){e.add(n)}),e}},{key:"values",value:function(){var e=new t;return this.each(function(t){e.add(t)}),e}},{key:"copy",value:function(){return new t(this.all())}},{key:"empty",value:function(){this._items={},this._count=0}},{key:"toArray",value:function(){var t=[];return this.each(function(e){t.push(e)}),t}},{key:"sort",value:function(e){return new t(this.toArray().sort(e))}},{key:"groupBy",value:function(e){var n=new t;return this.each(function(i){var a=e(i),s=n.findOrGet(a,function(){return new t});s.add(i)}),n}}]),t}();return t}(),Utility.Rectangle=function(){var t=function(){function t(e,n,i,a){_classCallCheck(this,t),this.x=e||0,this.y=n||0,this.w=i||0,this.h=a||0}return _createClass(t,[{key:"overlaps",value:function(t){return!(this.right<=t.x||t.right<=this.x||this.bottom<=t.y||t.bottom<=this.y)}},{key:"merge",value:function(e){var n=this.x<e.x?this.x:e.x,i=this.y<e.y?this.y:e.y,a=this.right>e.right?this.right:e.right,s=this.bottom>e.bottom?this.bottom:e.bottom;return new t(n,i,a-n,s-i)}},{key:"origin",get:function(){return new Utility.Vector2(this.x+this.w/2,this.y+this.h/2)}},{key:"bottom",get:function(){return this.y+this.h}},{key:"right",get:function(){return this.x+this.w}}]),t}();return t}(),Utility.Vector2=function(){var t=function(t){return"object"===("undefined"==typeof t?"undefined":_typeof(t))?t:new e(t)},e=function(){function e(t,n){_classCallCheck(this,e),this.set(t,n)}return _createClass(e,[{key:"set",value:function(t,e){this.x=t||0,this.y=void 0===e?t||0:e}},{key:"add",value:function(n){return n=t(n),new e(this.x+n.x,this.y+n.y)}},{key:"sub",value:function(n){return n=t(n),new e(this.x-n.x,this.y-n.y)}},{key:"multiply",value:function(n){return n=t(n),new e(this.x*n.x,this.y*n.y)}},{key:"divide",value:function(n){return n=t(n),new e(this.x/n.x,this.y/n.y)}},{key:"distance",value:function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}},{key:"move",value:function(t,n){return n=void 0!==n?n:1,new e(Math.sin(t),Math.cos(t)).multiply(n).add(this)}},{key:"copy",value:function(){return new e(this.x,this.y)}}]),e}();return e}(),Utility.Keyboard=function(){var t={},e=function(){var e={},n=0;for(n in t)e[n]=!0;return e},n=function(){function t(e){_classCallCheck(this,t),this.pass_state=null,this.curr_state=null}return _createClass(t,[{key:"update",value:function(){return this.pass_state=this.curr_state,this.curr_state=new Utility.KeyState(e()),this}},{key:"pressed",value:function(t){return this.curr_state.isDown(t)&&this.pass_state.isUp(t)}},{key:"released",value:function(t){return this.curr_state.isUp(t)&&this.pass_state.isDown(t)}},{key:"isDown",value:function(t){return this.curr_state.isDown(t)}},{key:"isUp",value:function(t){return this.curr_state.isUp(t)}}]),t}();return n.start=function(){document.addEventListener("keydown",function(e){t[e.keyCode]=!0},!1),document.addEventListener("keyup",function(e){delete t[e.keyCode]},!1)},n}(),Utility.Keys=function(){return{BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90}}(),Utility.KeyState=function(){var t=function(){function t(e){_classCallCheck(this,t),this.keys=e}return _createClass(t,[{key:"isDown",value:function(t){return this.keys[t]===!0}},{key:"isUp",value:function(t){return!this.isDown(t)}}]),t}();return t}(),Utility.Canvas=function(){var t=function(){function t(){_classCallCheck(this,t),this.canvas=null,this.context=null}return _createClass(t,[{key:"set",value:function(t){return this.canvas=document.getElementById(t),this.context=this.canvas.getContext("2d"),this}},{key:"create",value:function(t,e,n){var i=document.createElement("canvas");i.setAttribute("id",n||"canvas"),i.width=t,i.height=e,document.body.appendChild(i),this.set(n||"canvas")}},{key:"clear",value:function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this}},{key:"drawSprite",value:function(t){var e=t.getDrawRect();return 0!==t.rotation?(this.context.save(),this.context.translate(t.location.x,t.location.y),this.context.rotate(t.rotation),this.context.translate(-t.location.x,-t.location.y),this.drawImage(t.image,e,t.src_rect),this.context.restore()):this.drawImage(t.image,e,t.src_rect),this}},{key:"drawImage",value:function(t,e,n){return this.context.drawImage(t,n.x,n.y,n.w,n.h,e.x,e.y,e.w,e.h),this}},{key:"drawRect",value:function(t,e){return this.context.fillStyle=e||"white",this.context.fillRect(t.x,t.y,t.w,t.h),this}},{key:"drawText",value:function(t,e,n,i,a){this.context.font=(n||30)+"px "+(i||"Arial"),this.context.fillStyle=a||"black",this.context.fillText(t,e.x,e.y)}}]),t}();return t}(),function(){var t=Utility.Vector2,e=Utility.Rectangle,n=function(){function n(){_classCallCheck(this,n),this.src_rect=new e,this.location=new t(0),this.anchor=new t(0),this.scale=new t(1),this.size=new t(0),this.rotation=0,this.image=null}return _createClass(n,[{key:"getDrawRect",value:function(){var t=this.width,n=this.height;return new e(Math.round(this.location.x-t*this.anchor.x),Math.round(this.location.y-n*this.anchor.y),t,n)}},{key:"width",get:function(){return this.size.x*this.scale.x}},{key:"height",get:function(){return this.size.y*this.scale.y}}]),n}();n.animatable=function(t){var e={},n=null;return t.animation={add:function(t,n){var i=n.frames,a=n.speed,s=void 0===a?120:a;e[t]={current_frame:0,elapsed_time:0,frames:i,speed:s,name:t}},play:function(i){null!==n&&n.name===i||(n=e[i],n.current_frame=0,n.elapsed_time=0,t.src_rect=n.frames[0])},update:function(e){n.elapsed_time+=e,n.elapsed_time>n.speed&&(n.elapsed_time=0,n.current_frame=(n.current_frame+1)%n.frames.length,t.src_rect=n.frames[n.current_frame])}},t},Utility.Sprite=n}(),Utility.Load=function(){var t=function(){function t(){_classCallCheck(this,t),this.images=new Utility.Collection,this.data=new Utility.Collection}return _createClass(t,[{key:"image",value:function(t,e){return this.images.put(t,e),this}},{key:"json",value:function(t,e){this.data.put(t,e)}},{key:"onDone",value:function(t){var e=this,n=0,i=e.images.count()+e.data.count();return e.images.isEmpty()&&e.data.isEmpty()?t():(e.data.each(function(a,s){var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",a,!0),r.onreadystatechange=function(){4==r.readyState&&200==r.status&&(n++,e.data.put(s,JSON.parse(r.responseText)),n===i&&t())},r.send(null)}),e.images.each(function(a,s){var r=new Image;r.src=a,r.onload=function(){n++,e.images.put(s,r),n===i&&t()}})),e}}]),t}();return t}(),Utility.Game=function(){return{state:null,states:new Utility.Collection,canvas:new Utility.Canvas,load:new Utility.Load,keyboard:new Utility.Keyboard,addState:function(t,e){return this.states.put(t,e),this},setState:function(t){return this.state=this.states.get(t),this},run:function(t){var e=this;return void 0!==t&&e.states.isEmpty()&&(e.state=t,e.states.add(t)),null===e.state?(console.error("Set the inital game state. Use Utility.Game.setState() before calling Utility.Game.run()."),0):(Utility.Keyboard.start(),e.states.each(function(t){t.preload&&t.preload(e)}),void e.load.onDone(function(){e.states.each(function(t){t.onready&&t.onready(e)});var t=0,n=0,i=function a(i){n=i-t,e.keyboard.update(),e.state.update(n,e),e.state.render(e.canvas),t=i,requestAnimationFrame(a)};requestAnimationFrame(i)}))}}}();